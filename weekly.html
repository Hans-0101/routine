<!DOCTYPE html>
<html>
    <head>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1" />

        <!-- Bootstrap CSS -->
        <link
            href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-beta3/dist/css/bootstrap.min.css"
            rel="stylesheet"
            integrity="sha384-eOJMYsd53ii+scO/bJGFsiCZc+5NDVN2yr8+0RDqr0Ql0h+rP48ckxlpbzKgwra6"
            crossorigin="anonymous"
        />

        <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.6.1/font/bootstrap-icons.css">
        <link rel="stylesheet" href="style.css" />

        <title>Habit Maker</title>

        <header class="p-2 text-left">Habit Maker</header>
    </head>
    <body>
        <div class="top">
            <!--Date of today-->
            <div class="today"></div>

            <!--weekly and monthly page buttons-->
            <div class="page-buttons">
                <a class="btn btn-success" href="weekly.html">Weekly</a>
                <a class="btn btn-success" href="monthly.html">Monthly</a>
            </div>
        </div>

        <!--Days of week-->
        <div class="days-of-week">
            <div class="day">SUN</div>
            <div class="day">MON</div>
            <div class="day">TUE</div>
            <div class="day">WED</div>
            <div class="day">THU</div>
            <div class="day">FRI</div>
            <div class="day">SAT</div>
        </div>

        <!--Habits-->
        <div class="contents"></div>

        <div class="bottom">
            <!--Hidden text area and submit button-->
            <div class="inputArea" hidden="true">
                
                <div class="d-flex flex-column">
                    <div class="d-flex mb-2">
                    <input type="color" class="category" id="categoryColor"/>
                    <input type="text" class="form-control" id="categoryText" placeholder="CATEGORY here"/>
                    <input type="text" class="form-control" id="nameText" />
                    <button id="submit" type="submit" class="btn btn-outline-success">
                        Add
                    </button>
                    </div>
                
                <div class="day-select-area d-flex flex-row">
                    <button type="button" class="day-select selected">SUN</button>
                    <button type="button" class="day-select selected">MON</button>
                    <button type="button" class="day-select selected">TUE</button>
                    <button type="button" class="day-select selected">WED</button>
                    <button type="button" class="day-select selected">THU</button>
                    <button type="button" class="day-select selected">FRI</button>
                    <button type="button" class="day-select selected">SAT</button>
                </div>
                </div>
            </div>
            <!--Add button-->
            <button class="button add"><i class="bi bi-plus-lg"></i></button>
        </div>

        <script>
            // Date of today
            let today = new Date();
            let month = today.getMonth() + 1;
            let date = today.getDate();
            let day = today.getDay();
            let week = ["Sun", "Mon", "Tue", "Wed", "Thu", "Fri", "Sat"];
            document.querySelector(".today").textContent =
                month + " " + date + " " + week[day];

            // Accomplishment status
            let status = {
                empty: 0,
                done: 1,
                failed: 2,
                disabled: -1
            };

            // Habit object
            let nameText = "";
            let categoryText = "";
            let colorText = "black";
            let habit = {
                name: nameText,
                weeklyStatus: [-1, -1, -1, -1, -1, -1, -1],              
                category: categoryText,
                cateColor: colorText,
            };


            // Load data when window is loaded
            function loadHabits() {
                let archive = [],
                    keys = Object.keys(localStorage),
                    i = 0,
                    key;

                for (; (key = keys[i]); i++) {
                    archive.push(JSON.parse(localStorage.getItem(key)));
                }
                archive.forEach(addHabit);
            }

            window.addEventListener("load", () => {
                loadHabits();
            });

            // Save habit object to local storage
            function saveHabit(habit) {
                // Use name of the habit as key
                localStorage.setItem(habit.name, JSON.stringify(habit));
            }

            // Create habit element and append to .contents
            function addHabit(habit) {
                /*
                <div class="habit-group">
                    <div class="habit">habit_name</div>
                    <div class="weekly-accomplishment">
                        <button class="btn btn-danger" id="delete-button"></button>
                        <div class="checkbox 0"></div>
                        <div class="checkbox 1"></div>
                        <div class="checkbox 2"></div>
                        <div class="checkbox 3"></div>
                        <div class="checkbox 4"></div>
                        <div class="checkbox 5"></div>
                        <div class="checkbox 6"></div>
                    </div>
                </div>
                */

                // Create habit-group element
                // .habit-group
                let div = document.createElement("div");
                div.className = "habit-group";

                // .habit
                let divHabit = document.createElement("div");
                divHabit.className = "habit";
                let Color = document.createElement("span");
                Color.style.color=habit.cateColor;
                Color.innerText="■ ";
                divHabit.appendChild(Color);
                // divHabit.innerHTML = '<span style="color: red">■ </span>';
                let text = document.createElement("span");
                text.innerText=habit.category + " | " + habit.name;
                divHabit.appendChild(text);
                // divHabit.innerText = habit.category + " | " + habit.name;
                div.appendChild(divHabit);

                // .weekly-accomplishment
                let divWeek = document.createElement("div");
                divWeek.className = "weekly-accomplishment";

                // delete button
                let deleteButton = document.createElement("button");
                deleteButton.className = "btn btn-danger";
                deleteButton.id = "delete-button";
                deleteButton.addEventListener("click", () => {
                    div.remove();
                    localStorage.removeItem(habit.name); // Remove data from local storage
                });

                let span = document.createElement("span"); // to make it visible when hovered
                span.appendChild(deleteButton);
                //divWeek.appendChild(deleteButton);
                divWeek.appendChild(span);

                // .checkbox
                for (day in week) {
                    let checkbox = document.createElement("div");
                    checkbox.className = "checkbox " + day; // add 0~6 to distinguish days
                    // status of the day (done or failed)
                    if (habit.weeklyStatus[day] === status.done) {
                        checkbox.classList.add("done");
                    } else if (habit.weeklyStatus[day] === status.failed) {
                        checkbox.classList.add("failed");
                    } else if (habit.weeklyStatus[day] === status.disabled) {
                        checkbox.classList.add("disabled");
                    } // is this right??

                    // Add eventlistener
                    // Click to change status : empty->done->failed
                    checkbox.addEventListener("click", () => {
                        if (checkbox.classList.contains("disabled")) return;
                        if (checkbox.classList.contains("done")) {
                            checkbox.classList.replace("done", "failed");
                            habit.weeklyStatus[checkbox.classList[1]] =
                                status.failed; // Update weeklyStatus of habit object
                        } else if (checkbox.classList.contains("failed")) {
                            checkbox.classList.remove("failed");
                            habit.weeklyStatus[checkbox.classList[1]] =
                                status.empty;
                        } else {
                            checkbox.classList.add("done");
                            habit.weeklyStatus[checkbox.classList[1]] =
                                status.done;
                        }

                        // Save status
                        saveHabit(habit);
                    });

                    divWeek.appendChild(checkbox); // Append to weekly-accomplishment class
                }

                div.appendChild(divWeek);

                // Append to .contents
                let contents = document.querySelector(".contents");
                contents.appendChild(div);

                saveHabit(habit); // Save to local storage
            }

            // Add eventlistener to Add button
            let addButton = document.querySelector(".button.add");

            let inputArea = document.querySelector(".inputArea");

            addButton.addEventListener("click", () => {
                inputArea.hidden ? inputArea.hidden = false : inputArea.hidden = true;
                //inputArea.hidden = false;
            });

            // Add eventlistener to Submit button
            let submitButton = document.querySelector("#submit");
            submitButton.addEventListener("click", () => {
                let textInput = document.getElementById("nameText").value;
                let categoryInput = document.getElementById("categoryText").value;
                let categoryInputColor = document.getElementById("categoryColor").value;

                if(textInput==="" || categoryInput==="") return;

                // Create new habit object
                let newHabit = {
                    name: textInput,
                    weeklyStatus: [-1, -1, -1, -1, -1, -1, -1],                      
                    category: categoryInput,
                    cateColor: categoryInputColor,
                };

                let selectDays = document.querySelectorAll(".day-select");
                for (let i=0; i<7; i++){
                    if(selectDays[i].classList.contains("selected")){
                        newHabit.weeklyStatus[i] = 0;
                    }
                }
                document.getElementById("nameText").value = ""; // Clear the text
                document.getElementById("categoryText").value = "";
                // document.getElementById("categoryInputColor").value = "";
                inputArea.hidden = true;
                selectDays.forEach(e => e.classList.remove("selected"));
                addHabit(newHabit);
            });

            document.querySelectorAll(".day-select").forEach((e) => {
                e.addEventListener("click", () => {
                    if(e.classList.contains("selected")) {
                        e.classList.remove("selected");
                    } else {
                        e.classList.add("selected");
                    }
                })
            })
        </script>
    </body>
</html>
